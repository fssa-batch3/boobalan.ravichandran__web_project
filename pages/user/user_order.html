<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="icon" type="image/x-icon" href="../../assets/images/icon.png">
  
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500;1,600&display=swap" rel="stylesheet">
   
        <link rel="stylesheet" href="../../assets/css/style.css">
        <link rel="stylesheet" href="../../assets/css/footer.css">
    
        <link rel="stylesheet" href="../../assets/css/user_order.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
        <title>My order Page</title>
    </head>

    <body>

        <main>
            <div class="empty_order" id="empty_orderr">
                <img src="https://mir-s3-cdn-cf.behance.net/projects/404/8412d0104101523.Y3JvcCwxMDI0LDgwMCwwLDcw.jpg" alt="empty order"> 
                <button id="start_shopping" type="button">Start Shopping</button>
            </div>
            <div class="all-order-details-container" id="order_tablee">
          
            </div>
        </main>

      
        <div class="mobile_order_page">
            <h2>Order details</h2>
            <div class="mobile_order_details">
                <div class="mobile_order_content">
                    <div class="order_image">
                        <img src="../../assets/images/Adama/ada1.avif" alt="last order">
                    </div>
                    <div class="order_delivery_date">
                        <p>15/08/2022</p>
                        <p>Completed</p>
                        <p>Rs:2300</p>
                    </div>
                    <div class="order_delivery_details">
                        <a href="./order_deliver.html">
                            <i class="fa fa-angle-double-right" style="font-size:24px"></i>
                        </a>
                    </div>
                </div>
                <div class="mobile_order_content">
                    <div class="order_image">
                        <img src="../../assets/images/bayer/bay1.avif" alt="order">
                    </div>
                    <div class="order_delivery_date">
                        <p>23/04/2022</p>
                        <p>Completed</p>
                        <p>Rs:1650</p>
                    </div>
                    <div class="order_delivery_details">
                        <a href="./order_deliver1.html">
                            <i class="fa fa-angle-double-right" style="font-size:24px"></i>
                        </a>
                    </div>
                </div>
                <div class="mobile_order_content">
                    <div class="order_image">
                        <img src="../../assets/images/Bio Fertilizers/bio1.jpg" alt="order1">
                    </div>
                    <div class="order_delivery_date">
                        <p>18/11/2021</p>
                        <p>Cancelled</p>
                        <p>Rs:890</p>
                    </div>
         
                    <div class="order_delivery_details">
                        <a href="./order_deliver2.html">
                            <i class="fa fa-angle-double-right" style="font-size:24px"></i>
                        </a>
                    </div>
        
                </div>
                <div class="mobile_order_content">
                    <div class="order_image">
                        <img src="../../assets/images/dhanuka/dhan1.jpg" alt="order2">
                    </div>
                    <div class="order_delivery_date"> 
                        <p>18/11/2021</p>
                        <p>Completed</p>
                        <p>Rs:1890</p>
                    </div>
                    <div class="order_delivery_details">
                        <a href="./order_deliver1.html">
                            <i class="fa fa-angle-double-right" style="font-size:24px"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="footer1">
                <div class="img101">
                    <a href="../../index.html">
                        <img src="../../assets/images/Fert agri.png" alt="logo">
                    </a>
                </div>
                <div class="about111">
                    <div class="quick">
                        <h2>QUICK LINKS</h2>
                        <p>
                            <a href="./about_us.html">ABOUT US</a>
                        </p>
                        <p>
                            <a href="./wishlist.html">WISHLIST</a>
                        </p>
                        <p>
                            <a href="./offers.html">OFFERS</a>
                        </p>
                        <p>
                            <a href="./user_interface.html">HOME</a>
                        </p>
                    </div>
                    <div class="quick">
                        <h2>BRANDS</h2>
                        <p>
                            <a href="./dhanuka.html">DHANUKA</a>
                        </p>
                        <p>
                            <a href="./dow_agro.html">DOW AGRO SCIENCE</a>
                        </p>
                        <p>
                            <a href="./upl.html">UPL</a>
                        </p>
                        <p>
                            <a href="./tata.html"> TATA RALLIS</a>
                        </p>
                        <p>
                            <a href="./adama.html">ADAMA</a>
                        </p>
                        <p>
                            <a href="./bayer.html">BAYER</a>
                        </p>
                    </div>
                    <div class="quick">
                        <h2>CROP PROTECTION</h2>
                        <p>
                            <a href="./insecticides.html">BIO INSECTICIDES</a>
                        </p>
                        <p>
                            <a href="./fungicides.html">BIO FUNGICIDES</a>
                        </p>
                        <p>
                            <a href="./nematicides.html">BIO NEMATICIDES</a>
                        </p>
                        <p>
                            <a href="./viricides.html"> BIO VIRCIDES</a>
                        </p>
                    </div>
                    <div class="quick">
                        <h2>CONTACT US</h2>
                        <div class="rboomi">
                            <h3>EMAIL</h3>
                            <p> rboomibalan459@gmail.com</p>
                        </div>
                        <div class="rboomi">
                            <h3>PHONE</h3>
                            <p>+919629223356</p>
                        </div>
                        <div class="rboomi">
                            <h3>ADDRESS</h3>
                            <p> 1/115, Thirumurugan street, Mandumandram Nagar, Tiruchippalli-620021</p>
                        </div>
                    </div>
                </div>
                <div class="bottom">
                    <div class="cont">
                        <p>FOLLOW US</p>
                    </div>
                    <div class="social">
                        <a href="https://www.instagram.com/rp0803/?igshid=YmMyMTA2M2Y%3D">
                            <img src="../../assets/images/instagram.png" alt="instagram">
                        </a>
                        <a href="https://www.youtube.com/channel/UCufA2FcZ-8DSsbCog424g_g">
                            <img src="../../assets/images/youtube.webp" alt="youtube">
                        </a>
                        <a href="https://myaccount.google.com/?utm_source=OGB&tab=rk&utm_medium=app">
                            <img src="../../assets/images/mail.jpg" alt="email">
                        </a>
                        <a href="https://twitter.com/agrigoi?lang=en">
                            <img src="../../assets/images/twiter.png" alt="twitter">
                        </a>
                        <a href="https://www.facebook.com/people/Agriculture/100068310005265/">
                            <img src="../../assets/images/facebook.png" alt="facebook">
                        </a>
                        <a href="#">
                            <img src="../../assets/images/whatsapp.webp" alt="whatsapp">
                        </a>
    
                    </div>
                </div>
            </div>
        </footer>
        <div class="mobile_footer">
            <div class="mobile_aboutus">
                <a href="./user_interface.html">Home</a>
                <a href="about_us.html">
                    <p>About Us</p>
                </a>
                <p>(+91)9629223356</p>
        
            </div>
            <div class="copyright">
                <p> Copyright Â© 2021 - 2023 FAB - Designed By </p>
                <span>Boobalan-R</span>
            </div>
            <div class="mobile_social">
                <p>Contact Us</p>
                <div>
                    <a href="https://twitter.com/agrigoi?lang=en">
                        <img src="../../assets/images/twiter.png" alt="twitter">
                    </a>
                    <a href="https://www.youtube.com/channel/UCufA2FcZ-8DSsbCog424g_g">
                        <img src="../../assets/images/youtube.webp" alt="youtube">
                    </a>
                    <a href="https://www.facebook.com/people/Agriculture/100068310005265/">
                        <img src="../../assets/images/facebook.png" alt="facebook">
                    </a>
                </div>
            </div>
        </div>
       
        <!-- <script src="../js/menubar.js"></script> -->

        <!-- <script src="../js/user_orders.js"> -->
        
</script>
        <script src="../js/header.js"></script>
        <script src="../js/search.js"></script>
        <script>
      
  

      
        const logedUserDetails = JSON.parse(localStorage.getItem("user_data"));

const pro_path = window.location.origin;
const allProductDatas = JSON.parse(localStorage.getItem("products")) || [];
const findOrderIds = JSON.parse(localStorage.getItem("addtoCartDeliveryProduct")) ?? [];

const getloggedUser = JSON.parse(localStorage.getItem("user_data"));


const findOrderId = findOrderIds.filter((data) => data.userUniqueId === getloggedUser);


// find before user oredred or not 
const orderMessage = document.getElementById("empty_orderr");
const orderTable = document.getElementById("order_tablee");

if (findOrderId.length === 0) {
  orderMessage.style.display = "block";
  orderTable.style.display = "none";
} else {
  orderMessage.style.display = "none";
  orderTable.style.display = "block";
}

document.getElementById("start_shopping").addEventListener("click", () => {
  window.location.href = `${pro_path}/index.html`;
});

// get addresses from local storage
const getAddresses = JSON.parse(localStorage.getItem("addresses")) || [];
// Get address
const getAddress = findOrderId.map((data) =>
  getAddresses.find((e) => e.addressId === data.addressUniqueID)
);

// const getAddressName = getAddress.map((data) =>
//   findOrderId.find((e) => e.addressUniqueID === data.addressId)
// );

// console.log(getAddressName);



const addressId = [];
for (let i = 0; i < getAddress.length; i++) {
  const addressUniqueId = getAddress[i].name;
  const matchedOrder = findOrderId[i].orderedTime
  const orderDates = findOrderId[i].orderDate
  const totalOrderPrice = findOrderId[i].totalPrice
  console.log(orderDates)

  if (!addressId.some((address) => address.id === addressUniqueId && address.time === matchedOrder && address.date === orderDates)) {
    addressId.push({ id: addressUniqueId, time: matchedOrder, date: orderDates ,totalPrice: totalOrderPrice});
  }
}

console.log(addressId);



const ordersId = [];
for (let i = 0; i < findOrderId.length; i++) {
  const orderUniqueId = findOrderId[i].orderUniqueId;
  if (!ordersId.includes(orderUniqueId)) {
    ordersId.push(orderUniqueId);
  }
}

const allOrderDetailsContainer = document.querySelector(".all-order-details-container");

for (let i = 0; i < ordersId.length; i++) {
  const orderDetailsContainer = document.createElement("div");
  orderDetailsContainer.classList.add("order-details-container");

  const orderTitle = document.createElement("div");
  orderTitle.classList.add("order-title");

  const orderId = document.createElement("div");
  orderId.classList.add("order-id");
  orderId.innerHTML = `Order Id: <h4>${ordersId[i]}</h4>`;

  const personName = document.createElement("div");
  personName.classList.add("person-name");
  personName.innerHTML = `Person Name: <h4>${addressId[i].id}</h4>`;

  orderTitle.appendChild(orderId);
  orderTitle.appendChild(personName);

  const totalOrdersContainer = document.createElement("div");
  totalOrdersContainer.classList.add(`total-orders-container-${i}`);

  const totalPriceContainer = document.createElement("div");
  totalPriceContainer.classList.add("total-price-container");

  const cancelOrderButtonContainer = document.createElement("div");
  cancelOrderButtonContainer.classList.add("cancel-order-button-container");



  const cancelOrder = document.createElement("div");
  cancelOrder.classList.add("cancel-order");
  cancelOrder.innerText = "Cancel Order";



  if (findOrderId[i].orderStatus === "Cancelled" || findOrderId[i].orderStatus === "Delivered" ||  findOrderId[i].orderStatus === "Shipping") {
  cancelOrder.style.display = "none";
}
//   before deliver cancel button have to show
  cancelOrder.addEventListener("click", () => {
  const orderId = ordersId[i];
  const orderIndex = findOrderId.findIndex((data) => data.orderUniqueId === orderId);
  if (orderIndex !== -1) {
    if (confirm("Confirm order cancellation?")){
    findOrderId[orderIndex].orderStatus = "Cancelled";
    localStorage.setItem("addtoCartDeliveryProduct", JSON.stringify(findOrderId));
   window.location.reload();
    }
  }
});

if (findOrderId[i].orderStatus !== "Cancelled") {
      const currentDate = new Date();
      const day = String(currentDate.getDate()).padStart(2, "0");
      const month = String(currentDate.getMonth() + 1).padStart(2, "0");
      const year = currentDate.getFullYear();
      const formattedDate = `${day}/${month}/${year}`;

      // console.log("formattedDate:", formattedDate);

      const deliverydate = findOrderId[i].deliveryDate;
      const [inputDay, inputMonth, inputYear] = deliverydate.split("/");
      const inputDateObj = new Date(`${inputMonth}/${inputDay}/${inputYear}`);
      inputDateObj.setDate(inputDateObj.getDate() - 3);
      const threeDaysBeforeDate = `${String(inputDateObj.getDate()).padStart(2,"0")}/${String(inputDateObj.getMonth() + 1).padStart(2,"0")}/${inputDateObj.getFullYear()}`;

      console.log(threeDaysBeforeDate)
      // console.log("deliverydate:", deliverydate);
      // console.log("threeDaysBeforeDate:", threeDaysBeforeDate);

      if (threeDaysBeforeDate === formattedDate) {
        const status = "Shipping";
        findOrderId[i].orderStatus = status;
        localStorage.setItem(
          "addtoCartDeliveryProduct",
          JSON.stringify(findOrderId)
        );
      }

      if (deliverydate === formattedDate) {
        const ord_status = "Delivered";
        findOrderId[i].orderStatus = ord_status;
        localStorage.setItem(
          "addtoCartDeliveryProduct",
          JSON.stringify(findOrderId)
        );
      }
    }


  cancelOrderButtonContainer.appendChild(cancelOrder);

  const totalPrice = document.createElement("div");
  totalPrice.classList.add("total-price");
  totalPrice.innerHTML = `Total Price:<h4> â¹${addressId[i].totalPrice} </h4>`;

  totalPriceContainer.appendChild(cancelOrderButtonContainer);
  totalPriceContainer.appendChild(totalPrice);

  orderDetailsContainer.appendChild(orderTitle);
  orderDetailsContainer.appendChild(totalOrdersContainer);
  orderDetailsContainer.appendChild(totalPriceContainer);

  allOrderDetailsContainer.appendChild(orderDetailsContainer);

  const findProductDetails = findOrderId.filter((data) => data.orderUniqueId === ordersId[i]);

  const currentTotalOrdersContainer = document.querySelector(`.total-orders-container-${i}`);

  for (let j = 0; j < findProductDetails.length; j++) {
    const findUserAddressId = findProductDetails[j].addressUniqueID;
    const findcustomerName = getAddresses.find((data) => data.addressId === findUserAddressId);

    const matchedId = findProductDetails[j];
    const matchingProducts = allProductDatas.filter((product) => product.product_unique_id === matchedId.productUniqueId);
// ...

matchingProducts.forEach((product) => {
  const orderContainerFirst = document.createElement("div");
  orderContainerFirst.classList.add("order-container-first");

  const orderedProductImg = document.createElement("div");
  orderedProductImg.classList.add("ordered-product-img");

  const productImg = document.createElement("img");
  productImg.src = product.source;
  orderedProductImg.appendChild(productImg);

  const orderDateStatus = document.createElement("div");
  orderDateStatus.classList.add("order-date-status");

  const orderedDate = document.createElement("div");
  orderedDate.classList.add("ordered-date");
  const orderedDateHeading = document.createElement("h3");
  orderedDateHeading.innerText = "Ordered date:";
  const orderedDateDetails = document.createElement("h4");
  orderedDateDetails.classList.add("date-details");
  orderedDateDetails.innerText = findProductDetails[j].orderDate;
  orderedDate.appendChild(orderedDateHeading);
  orderedDate.appendChild(orderedDateDetails);

  const deliveryDate = document.createElement("div");
  deliveryDate.classList.add("delivery-date");
  const deliveryDateHeading = document.createElement("h3");
  deliveryDateHeading.innerText = "Delivery date:";
  const deliveryDateDetails = document.createElement("h4");
  deliveryDateDetails.classList.add("date-details");
  deliveryDateDetails.innerText = findProductDetails[j].deliveryDate;
  deliveryDate.appendChild(deliveryDateHeading);
  deliveryDate.appendChild(deliveryDateDetails);

  const orderStatus = document.createElement("div");
  orderStatus.classList.add("order-status");
  const orderStatusHeading = document.createElement("h3");
  orderStatusHeading.innerText = "Order Status:";
  const orderStatusDetails = document.createElement("h4");
  orderStatusDetails.classList.add("date-status");
  orderStatusDetails.innerText = findProductDetails[j].orderStatus;
  orderStatus.appendChild(orderStatusHeading);
  orderStatus.appendChild(orderStatusDetails);

  orderDateStatus.appendChild(orderedDate);
  orderDateStatus.appendChild(deliveryDate);
  orderDateStatus.appendChild(orderStatus);

  const orderNextPage = document.createElement("div");
  orderNextPage.classList.add("order-next-page");

  const orderDetailsLink = document.createElement("a");
  orderDetailsLink.href = `${pro_path}/pages/user/order_deliver.html?orderDetails=${findProductDetails[j].orderUniqueId}&productUniqueId=${product.product_unique_id}`;
  orderDetailsLink.innerHTML = `View Details<i class="fa fa-eye"></i>`;

  orderNextPage.appendChild(orderDetailsLink);

  orderContainerFirst.appendChild(orderedProductImg);
  orderContainerFirst.appendChild(orderDateStatus);
  orderContainerFirst.appendChild(orderNextPage);

  currentTotalOrdersContainer.appendChild(orderContainerFirst);
});

  }
};
        </script>
    </body>
</html>
